CC=i586-mingw32msvc-gcc
CXX=i586-mingw32msvc-g++
WINDRES=i586-mingw32msvc-windres
WVPORTS=$(HOME)/src/wvports
XPLC=$(WVPORTS)/xplc/build/xplc
OPENSSL=$(WVPORTS)/openssl/build/openssl
WVSTREAMS=$(HOME)/src/wvstreams-win32-2007/wvstreams.new
CFLAGS=-Wall \
	-D_MSC_VER=1300 \
	-DUNICODE_SUPPORT -DODBCVER=0x0351 -D_WIN32_WINNT=0x0501 \
	-DWIN_MULTITHREAD_SUPPORT \
	-I$(WVSTREAMS)/include -I$(XPLC)/include \
	-I/usr/include/postgresql
CXXFLAGS=$(CFLAGS)
RSCFLAGS=-DUNICODE_SUPPORT
LIBS=\
	-L$(WVSTREAMS) -lwvwin32 \
	-L$(XPLC) -lxplc-cxx -lxplc \
	-L$(OPENSSL) -lssl -lcrypto \
	-lodbc32 -lodbccp32 \
	-lws2_32 -lwinmm -lgdi32 -lkernel32 
LDFLAGS=--enable-stdcall-fixup -s

OBJS=\
	bind.o \
	columninfo.o \
	connection.o \
	convert.o \
	dlg_specific.o \
	dlg_wingui.o \
	drvconn.o \
	environ.o \
	execute.o \
	info.o \
	info30.o \
	lobj.o \
	win_md5.o \
	misc.o \
	mylog.o \
	pgapi30.o \
	multibyte.o \
	options.o \
	parse.o \
	pgtypes.o \
	psqlodbc.o \
	qresult.o \
	results.o \
	setup.o \
	socket.o \
	statement.o \
	tuple.o \
	odbcapi.o \
	odbcapi30.o \
	descriptor.o \
	win_unicode.o \
	odbcapiw.o \
	odbcapi30w.o \
	inouealc.o \
	wvlogger.o \
	vxodbc.res.o \
	vxodbc.def

all: vxodbc.dll	

vxodbc.dll: $(OBJS)

clean:
	rm -f *.o *~ *.res *.dll *.a .*.d *.d

%.res.o: %.rc
	$(WINDRES) $< $@

%.E: %.c
	$(CC) -o $@ -E $< $(CFLAGS)
	
%.o: %.c
	@echo Compiling $@...
	@$(CC) -o $@ -c -MMD -MP -MF .$*.d $< $(CFLAGS)

%.o: %.cc
	@echo Compiling $@...
	@$(CXX) -o $@ -c -MMD -MP -MF .$*.d $< $(CXXFLAGS)
	
%.dll: %.def
	@echo Linking $@...
	@$(CXX) -shared -o $@ \
		$(LDFLAGS) \
		$^ \
		-Wl,--out-implib,$*.a \
		$(LIBS) \
		2>&1 | grep -v '^Warning: resolving .* by linking to' >&2

include $(wildcard .*.d)
