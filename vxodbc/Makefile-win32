include Makefile-common

CC=i586-mingw32msvc-g++
CXX=i586-mingw32msvc-g++
WINDRES=i586-mingw32msvc-windres
WVPORTS=../wv/wvports
XPLC=$(WVPORTS)/xplc/build/xplc
OPENSSL=$(WVPORTS)/openssl/build/openssl
DBUS=$(WVPORTS)/dbus/build/dbus/dbus/.libs
ARGP=$(WVPORTS)/argp/build/argp
BOOST=$(WVPORTS)/boost/build/boost
ZLIB=$(WVPORTS)/zlib/build/zlib
W32API=$(WVPORTS)/win32api/build/w32api
WVSTREAMS=../wv/wvstreams
CFLAGS=-w \
	-D_MSC_VER=1300 \
	-DUNICODE_SUPPORT -DODBCVER=0x0351 -D_WIN32_WINNT=0x0501 \
	-DWIN_MULTITHREAD_SUPPORT \
	-I$(WVSTREAMS)/include -I$(XPLC)/include -I$(BOOST) \
	-I/usr/include/postgresql -I$(W32API)/include
CXXFLAGS=$(CFLAGS)
RSCFLAGS=-DUNICODE_SUPPORT
LIBS=\
	-L$(WVSTREAMS) -lwvstatic \
	-L$(DBUS) -ldbus-1 \
	-L$(XPLC) -lxplc-cxx -lxplc \
	-L$(OPENSSL) -lssl -lcrypto -L$(ARGP) -largp \
	-L$(ZLIB) -lz -L$(W32API)/lib \
	-limagehlp \
	-lole32 -lrpcrt4 \
	-lodbc32 -lodbccp32 \
	-lws2_32 -lwinmm -lgdi32 -lkernel32  -lcrypt32
LDFLAGS=--enable-stdcall-fixup -s

OBJS+=\
	setup.o \
	vxodbc.res.o \
	vxodbc.def


all: wvdbusd.dll vxodbc.dll	

%.res.o: %.rc
	$(WINDRES) $< $@

wvdbusd.dll: wvdbusd.o wvdbusd.def
	@echo Linking $@...
	@$(CXX) \
		-o $@ \
		-shared \
		$(LDFLAGS) \
		$^ \
		-Wl,--out-implib,wvdbusd.a \
		-Wl,-Map,wvdbusd.map \
		$(LIBS) \
		2>&1 | grep -v '^Warning: resolving .* by linking to' >&2

vxodbc.dll: $(OBJS)
	@echo Linking $@...
	@$(CXX) \
		-o $@ \
		-shared \
		$(LDFLAGS) \
		$^ \
		-Wl,--out-implib,vxodbc.a \
		-Wl,-Map,vxodbc.map \
		$(LIBS) \
		2>&1 | grep -v '^Warning: resolving .* by linking to' >&2

test: vxodbc.dll vxodbc.a
